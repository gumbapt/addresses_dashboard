# üìä Sistema de Relat√≥rios - Design Completo e Objetivo Final

## üéØ **Objetivo Final**

O sistema foi projetado para atender dois cen√°rios principais:

### **1. Relat√≥rios por Dom√≠nio Espec√≠fico** üè¢
- **Filtro por data**: Relat√≥rios de um dom√≠nio espec√≠fico em per√≠odos determinados
- **Agrega√ß√£o temporal**: Merge de todos os relat√≥rios de um dom√≠nio ao longo do tempo
- **Dashboard individual**: Vis√£o completa de um dom√≠nio espec√≠fico

### **2. Relat√≥rios Cross-Domain (Global)** üåê
- **Agrega√ß√£o de todos os dom√≠nios**: Ranking de dom√≠nios por volume de consultas
- **An√°lise de tecnologias**: Distribui√ß√£o de tecnologias entre todos os dom√≠nios
- **M√©tricas globais**: Estat√≠sticas consolidadas de toda a plataforma

---

## üèóÔ∏è **Arquitetura Atual**

### **1. Estrutura de Dados**

#### **Entidades Principais**
```php
Domain (dom√≠nios)
‚îú‚îÄ‚îÄ id, name, api_key, status
‚îú‚îÄ‚îÄ Relacionamento: hasMany(Report)

Report (relat√≥rios individuais)
‚îú‚îÄ‚îÄ id, domain_id, report_date, status
‚îú‚îÄ‚îÄ raw_data (JSON com dados originais)
‚îú‚îÄ‚îÄ Relacionamentos: belongsTo(Domain), hasMany(ReportSummary, ReportProvider, etc.)

ReportSummary (resumo processado)
‚îú‚îÄ‚îÄ report_id, total_requests, success_rate, avg_speed
‚îú‚îÄ‚îÄ Relacionamento: belongsTo(Report)

ReportProvider (provedores por relat√≥rio)
‚îú‚îÄ‚îÄ report_id, provider_id, technology, total_count, success_rate
‚îú‚îÄ‚îÄ Relacionamento: belongsTo(Report), belongsTo(Provider)

ReportState/City/ZipCode (dados geogr√°ficos por relat√≥rio)
‚îú‚îÄ‚îÄ report_id, state_id/city_id/zipcode_id, request_count
‚îú‚îÄ‚îÄ Relacionamento: belongsTo(Report), belongsTo(State/City/ZipCode)
```

#### **Fluxo de Processamento**
```mermaid
graph TD
    A[Submiss√£o de Relat√≥rio] --> B[Valida√ß√£o]
    B --> C[Cria√ß√£o do Report]
    C --> D[ProcessReportJob]
    D --> E[Processamento dos Dados]
    E --> F[Inser√ß√£o nas Tabelas Processadas]
    F --> G[Status: processed]
```

---

## üîß **Funcionalidades Implementadas**

### **1. Submiss√£o de Relat√≥rios** ‚úÖ

#### **Endpoint Principal**
```http
POST /api/reports/submit
Headers: X-API-KEY: {domain_api_key}
```

#### **Endpoint Di√°rio (WordPress)**
```http
POST /api/reports/submit-daily
Headers: X-API-KEY: {domain_api_key}
```

**Caracter√≠sticas:**
- ‚úÖ Autentica√ß√£o por API Key
- ‚úÖ Valida√ß√£o de dados
- ‚úÖ Upsert logic (atualiza relat√≥rios existentes para mesma data)
- ‚úÖ Processamento ass√≠ncrono via Jobs
- ‚úÖ Suporte a m√∫ltiplos formatos (original + WordPress)

### **2. Visualiza√ß√£o Individual** ‚úÖ

#### **Relat√≥rio Espec√≠fico**
```http
GET /api/admin/reports/{id}
Headers: Authorization: Bearer {admin_token}
```

**Retorna:**
- ‚úÖ Dados processados estruturados
- ‚úÖ Summary, providers, geographic data
- ‚úÖ Raw data original

### **3. Agrega√ß√£o por Dom√≠nio** ‚úÖ

#### **Dashboard do Dom√≠nio**
```http
GET /api/admin/reports/domain/{domain_id}/dashboard
Headers: Authorization: Bearer {admin_token}
```

**Retorna:**
- ‚úÖ KPIs agregados (total_requests, success_rate, etc.)
- ‚úÖ Distribui√ß√£o de provedores
- ‚úÖ Top estados/cidades/CEPs
- ‚úÖ Distribui√ß√£o por hor√°rio
- ‚úÖ Velocidade m√©dia por estado
- ‚úÖ Distribui√ß√£o de tecnologias
- ‚úÖ Taxa de exclus√£o por provedor

#### **Agrega√ß√£o Estat√≠stica**
```http
GET /api/admin/reports/domain/{domain_id}/aggregate
Headers: Authorization: Bearer {admin_token}
```

**Retorna:**
- ‚úÖ Merge de todos os relat√≥rios do dom√≠nio
- ‚úÖ Summary agregado (soma total_requests, m√©dia success_rate)
- ‚úÖ Top providers agregados
- ‚úÖ Top estados/cidades/CEPs agregados
- ‚úÖ Trends di√°rios (evolu√ß√£o ao longo do tempo)

---

## üöß **Funcionalidades Pendentes (Objetivo Final)**

### **1. Relat√≥rios Cross-Domain** ‚ùå

#### **Ranking de Dom√≠nios**
```http
GET /api/admin/reports/global/domain-ranking
Headers: Authorization: Bearer {admin_token}
```

**Deve retornar:**
- ‚ùå Ranking de dom√≠nios por volume de consultas
- ‚ùå Top dom√≠nios por per√≠odo
- ‚ùå Compara√ß√£o entre dom√≠nios

#### **An√°lise Global de Tecnologias**
```http
GET /api/admin/reports/global/technology-analysis
Headers: Authorization: Bearer {admin_token}
```

**Deve retornar:**
- ‚ùå Distribui√ß√£o de tecnologias entre todos os dom√≠nios
- ‚ùå Top tecnologias por volume
- ‚ùå Evolu√ß√£o das tecnologias ao longo do tempo

#### **M√©tricas Globais**
```http
GET /api/admin/reports/global/metrics
Headers: Authorization: Bearer {admin_token}
```

**Deve retornar:**
- ‚ùå Total de consultas de todos os dom√≠nios
- ‚ùå Taxa de sucesso global
- ‚ùå Distribui√ß√£o geogr√°fica global
- ‚ùå Top provedores globais

### **2. Filtros Avan√ßados** ‚ùå

#### **Filtro por Per√≠odo**
```http
GET /api/admin/reports/domain/{domain_id}/aggregate?date_from=2025-01-01&date_to=2025-01-31
```

#### **Filtro por Status**
```http
GET /api/admin/reports?status=processed&domain_id=1
```

#### **Filtro por Tecnologia**
```http
GET /api/admin/reports/global/technology-analysis?technology=Fiber
```

---

## üìä **Estrutura de Dados para Cross-Domain**

### **1. Tabelas de Agrega√ß√£o Global**

#### **Domain Rankings**
```sql
CREATE TABLE domain_rankings (
    id BIGSERIAL PRIMARY KEY,
    domain_id BIGINT REFERENCES domains(id),
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    total_requests BIGINT,
    success_rate DECIMAL(5,2),
    unique_providers INTEGER,
    rank_position INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(domain_id, period_start, period_end)
);
```

#### **Global Technology Stats**
```sql
CREATE TABLE global_technology_stats (
    id BIGSERIAL PRIMARY KEY,
    technology VARCHAR(50) NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    total_requests BIGINT,
    domain_count INTEGER,
    avg_success_rate DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(technology, period_start, period_end)
);
```

### **2. Use Cases Necess√°rios**

#### **GetGlobalDomainRankingUseCase**
```php
class GetGlobalDomainRankingUseCase
{
    public function execute(?string $dateFrom = null, ?string $dateTo = null): array
    {
        // Agregar todos os dom√≠nios por per√≠odo
        // Calcular ranking por volume de consultas
        // Retornar top dom√≠nios
    }
}
```

#### **GetGlobalTechnologyAnalysisUseCase**
```php
class GetGlobalTechnologyAnalysisUseCase
{
    public function execute(?string $technology = null): array
    {
        // Analisar distribui√ß√£o de tecnologias
        // Calcular m√©tricas por tecnologia
        // Retornar an√°lise global
    }
}
```

#### **GetGlobalMetricsUseCase**
```php
class GetGlobalMetricsUseCase
{
    public function execute(): array
    {
        // Calcular m√©tricas globais
        // Total de consultas, taxa de sucesso
        // Distribui√ß√£o geogr√°fica global
    }
}
```

---

## üîÑ **Fluxo de Dados Completo**

### **1. Submiss√£o e Processamento**
```mermaid
graph TD
    A[Cliente Submete Relat√≥rio] --> B[Valida√ß√£o]
    B --> C[Cria√ß√£o/Atualiza√ß√£o do Report]
    C --> D[ProcessReportJob]
    D --> E[Processamento dos Dados]
    E --> F[Inser√ß√£o nas Tabelas Processadas]
    F --> G[Atualiza√ß√£o de Agrega√ß√µes]
    G --> H[Cache Invalidation]
```

### **2. Visualiza√ß√£o**
```mermaid
graph TD
    A[Admin Acessa Dashboard] --> B{Consulta Individual ou Agregada?}
    B -->|Individual| C[GetReportWithStatsUseCase]
    B -->|Por Dom√≠nio| D[GetDashboardDataUseCase]
    B -->|Cross-Domain| E[GetGlobalMetricsUseCase]
    C --> F[Retorna Dados Processados]
    D --> G[Retorna Agrega√ß√£o do Dom√≠nio]
    E --> H[Retorna M√©tricas Globais]
```

---

## üéØ **Roadmap de Implementa√ß√£o**

### **Fase 1: Cross-Domain B√°sico** üöß
1. **Criar tabelas de agrega√ß√£o global**
   - `domain_rankings`
   - `global_technology_stats`
   - `global_metrics`

2. **Implementar Use Cases**
   - `GetGlobalDomainRankingUseCase`
   - `GetGlobalTechnologyAnalysisUseCase`
   - `GetGlobalMetricsUseCase`

3. **Criar endpoints**
   - `/api/admin/reports/global/domain-ranking`
   - `/api/admin/reports/global/technology-analysis`
   - `/api/admin/reports/global/metrics`

### **Fase 2: Filtros Avan√ßados** üöß
1. **Implementar filtros por per√≠odo**
2. **Implementar filtros por tecnologia**
3. **Implementar filtros por status**

### **Fase 3: Otimiza√ß√µes** üöß
1. **Cache de agrega√ß√µes**
2. **Jobs de pr√©-c√°lculo**
3. **√çndices de performance**

---

## üìà **Exemplos de Uso**

### **1. Dashboard Individual (Atual)**
```bash
# Dashboard do dom√≠nio zip.50g.io
curl -s "http://localhost:8006/api/admin/reports/domain/1/dashboard" \
  -H "Authorization: Bearer $TOKEN" | jq '.data.kpis'
```

**Resposta:**
```json
{
  "kpis": {
    "total_requests": 1502,
    "success_rate": 85.15,
    "avg_speed": 1502.89,
    "unique_providers": 84,
    "unique_states": 20
  }
}
```

### **2. Ranking Global (Futuro)**
```bash
# Ranking de todos os dom√≠nios
curl -s "http://localhost:8006/api/admin/reports/global/domain-ranking" \
  -H "Authorization: Bearer $TOKEN" | jq '.data.ranking'
```

**Resposta esperada:**
```json
{
  "ranking": [
    {
      "domain": {
        "id": 1,
        "name": "zip.50g.io"
      },
      "total_requests": 1502,
      "success_rate": 85.15,
      "rank": 1
    },
    {
      "domain": {
        "id": 2,
        "name": "outro-dominio.com"
      },
      "total_requests": 1200,
      "success_rate": 78.5,
      "rank": 2
    }
  ]
}
```

### **3. An√°lise de Tecnologias (Futuro)**
```bash
# An√°lise global de tecnologias
curl -s "http://localhost:8006/api/admin/reports/global/technology-analysis" \
  -H "Authorization: Bearer $TOKEN" | jq '.data.technologies'
```

**Resposta esperada:**
```json
{
  "technologies": [
    {
      "technology": "Mobile",
      "total_requests": 5000,
      "domain_count": 3,
      "avg_success_rate": 82.5
    },
    {
      "technology": "Fiber",
      "total_requests": 3000,
      "domain_count": 2,
      "avg_success_rate": 95.2
    }
  ]
}
```

---

## üîç **Status Atual vs Objetivo Final**

| Funcionalidade | Status Atual | Objetivo Final | Implementado |
|----------------|--------------|----------------|--------------|
| **Submiss√£o de Relat√≥rios** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Relat√≥rio Individual** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Dashboard por Dom√≠nio** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Agrega√ß√£o por Dom√≠nio** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Ranking de Dom√≠nios** | ‚ùå | ‚úÖ | ‚ùå |
| **An√°lise Global de Tecnologias** | ‚ùå | ‚úÖ | ‚ùå |
| **M√©tricas Globais** | ‚ùå | ‚úÖ | ‚ùå |
| **Filtros por Per√≠odo** | ‚ùå | ‚úÖ | ‚ùå |
| **Filtros por Tecnologia** | ‚ùå | ‚úÖ | ‚ùå |

---

## üéâ **Conclus√£o**

O sistema atual j√° implementa **60% do objetivo final**, com todas as funcionalidades b√°sicas de relat√≥rios por dom√≠nio funcionando perfeitamente. 

**Pr√≥ximos passos:**
1. Implementar funcionalidades cross-domain
2. Adicionar filtros avan√ßados
3. Otimizar performance com cache e agrega√ß√µes

O design atual √© s√≥lido e permite f√°cil extens√£o para as funcionalidades pendentes, mantendo a arquitetura limpa e escal√°vel.

---

## üìö **Documenta√ß√£o Relacionada**

- [API Guide](./REPORTS_API_GUIDE.md) - Guia completo da API atual
- [Dashboard Guide](./DASHBOARD_COMPLETO.md) - Documenta√ß√£o do dashboard
- [Daily Reports Guide](./ENDPOINT_DIARIOS_COMPLETO.md) - Relat√≥rios di√°rios
- [System Design](./ISP_REPORTING_SYSTEM.md) - Design t√©cnico detalhado
