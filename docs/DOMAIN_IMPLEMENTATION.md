# Domain Management - Implementa√ß√£o Completa

## ‚úÖ Implementa√ß√£o Finalizada

Sistema completo de gerenciamento de **Domains** (dom√≠nios parceiros) implementado seguindo Clean Architecture e DDD.

---

## üìÅ Arquivos Criados/Modificados

### Domain Layer

#### **Entities**
- ‚úÖ `app/Domain/Entities/Domain.php`
  - Entity imut√°vel representando um dom√≠nio
  - M√©todos: `toDto()`

#### **Repositories (Interfaces)**
- ‚úÖ `app/Domain/Repositories/DomainRepositoryInterface.php`
  - M√©todos principais: `findById`, `findBySlug`, `findByApiKey`
  - Pagina√ß√£o: `findAllPaginated`
  - CRUD: `create`, `update`, `delete`
  - Utilit√°rios: `activate`, `deactivate`, `regenerateApiKey`

### Application Layer

#### **DTOs**
- ‚úÖ `app/Application/DTOs/Domain/DomainDto.php`
  - DTO para transfer√™ncia de dados
  - M√©todo `toArray()` para serializa√ß√£o

#### **Use Cases**
- ‚úÖ `app/Application/UseCases/Domain/GetAllDomainsUseCase.php`
  - Lista todos os dom√≠nios
  - Suporta pagina√ß√£o e filtros
  - Retorna array de Domain entities
  
- ‚úÖ `app/Application/UseCases/Domain/GetDomainByIdUseCase.php`
  - Busca dom√≠nio por ID
  - Retorna Domain entity
  
- ‚úÖ `app/Application/UseCases/Domain/CreateDomainUseCase.php`
  - Cria novo dom√≠nio
  - Gera API key automaticamente
  - Retorna Domain entity
  
- ‚úÖ `app/Application/UseCases/Domain/UpdateDomainUseCase.php`
  - Atualiza informa√ß√µes do dom√≠nio
  - Retorna Domain entity
  
- ‚úÖ `app/Application/UseCases/Domain/DeleteDomainUseCase.php`
  - Remove dom√≠nio do sistema
  - Retorna void
  
- ‚úÖ `app/Application/UseCases/Domain/RegenerateApiKeyUseCase.php`
  - Gera nova API key para o dom√≠nio
  - Retorna Domain entity

### Infrastructure Layer

#### **Repositories**
- ‚úÖ `app/Infrastructure/Repositories/DomainRepository.php`
  - Implementa√ß√£o concreta usando Eloquent
  - Busca com filtros (search, is_active)
  - Pagina√ß√£o completa
  - Gera√ß√£o autom√°tica de slug
  - Gera√ß√£o de API keys no formato `dmn_live_{64_chars}`

#### **Models**
- ‚úÖ `app/Models/Domain.php` (atualizado)
  - Fillable fields expandidos
  - Cast de `settings` para array
  - M√©todo `toEntity()` para converter para Domain Entity

### Presentation Layer

#### **Controllers**
- ‚úÖ `app/Http/Controllers/Api/Admin/DomainController.php`
  - CRUD completo com autoriza√ß√£o
  - Pagina√ß√£o e filtros
  - Valida√ß√£o de inputs
  - Tratamento de exce√ß√µes

#### **Routes**
- ‚úÖ `routes/api.php` (atualizado)
  - Rotas RESTful para domains
  - Protegidas por `auth:sanctum` e `admin.auth`
  - Endpoint especial para regenerar API key

### Database

#### **Factories**
- ‚úÖ `database/factories/DomainFactory.php`
  - Gera dados fake realistas
  - Estados: `inactive()`
  - Helpers: `withSpecificTimezone()`

#### **Seeders**
- ‚úÖ `database/seeders/PermissionSeeder.php` (atualizado)
  - Adicionadas 5 permiss√µes de domain:
    - `domain-create`
    - `domain-read`
    - `domain-update`
    - `domain-delete`
    - `domain-manage`

### Providers

- ‚úÖ `app/Providers/DomainServiceProvider.php` (atualizado)
  - Binding do `DomainRepositoryInterface` ‚Üí `DomainRepository`

### Testing

- ‚úÖ `tests/Feature/Admin/DomainManagementTest.php`
  - 12 testes completos
  - Cobertura de CRUD
  - Testes de pagina√ß√£o
  - Testes de busca e filtros
  - Testes de permiss√µes
  - Testes de valida√ß√£o

---

## üîå API Endpoints

Todos os endpoints requerem autentica√ß√£o de admin e permiss√µes espec√≠ficas.

### **GET /api/admin/domains**
Lista dom√≠nios com pagina√ß√£o.

**Permiss√£o:** `domain-read`

**Query Parameters:**
- `page` (int, default: 1)
- `per_page` (int, default: 15, max: 100)
- `search` (string) - Busca por name, slug ou domain_url
- `is_active` (boolean) - Filtrar por status

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "SmarterHome.ai",
      "slug": "smarterhome-ai",
      "domain_url": "zip.50g.io",
      "site_id": "wp-prod-zip50gio-001",
      "api_key": "dmn_live_abc123...",
      "status": "active",
      "timezone": "America/Los_Angeles",
      "wordpress_version": "6.8.3",
      "plugin_version": "2.0.0",
      "settings": {...},
      "is_active": true
    }
  ],
  "pagination": {
    "total": 50,
    "per_page": 15,
    "current_page": 1,
    "last_page": 4,
    "from": 1,
    "to": 15
  }
}
```

### **GET /api/admin/domains/{id}**
Detalhes de um dom√≠nio espec√≠fico.

**Permiss√£o:** `domain-read`

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "SmarterHome.ai",
    "slug": "smarterhome-ai",
    ...
  }
}
```

### **POST /api/admin/domains**
Cria novo dom√≠nio.

**Permiss√£o:** `domain-create`

**Request:**
```json
{
  "name": "New ISP Platform",
  "domain_url": "api.newisp.com",
  "site_id": "wp-prod-newisp-001",
  "timezone": "America/New_York",
  "wordpress_version": "6.8.3",
  "plugin_version": "2.0.0",
  "settings": {
    "enable_notifications": true,
    "report_frequency": "daily"
  }
}
```

**Response:**
```json
{
  "success": true,
  "message": "Domain created successfully",
  "data": {
    "id": 5,
    "name": "New ISP Platform",
    "slug": "new-isp-platform",
    "api_key": "dmn_live_xyz789abc...",
    "is_active": true,
    ...
  }
}
```

**‚ö†Ô∏è Importante:** A API key √© retornada apenas neste momento. Deve ser armazenada de forma segura pelo cliente.

### **PUT /api/admin/domains/{id}**
Atualiza dom√≠nio existente.

**Permiss√£o:** `domain-update`

**Request:**
```json
{
  "name": "Updated Name",
  "is_active": false,
  "timezone": "America/Chicago"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Domain updated successfully",
  "data": {...}
}
```

### **DELETE /api/admin/domains/{id}**
Remove dom√≠nio.

**Permiss√£o:** `domain-delete`

**Response:**
```json
{
  "success": true,
  "message": "Domain deleted successfully"
}
```

### **POST /api/admin/domains/{id}/regenerate-api-key**
Regenera API key do dom√≠nio.

**Permiss√£o:** `domain-manage`

**Response:**
```json
{
  "success": true,
  "message": "API key regenerated successfully. Please update your integration immediately.",
  "data": {
    "id": 1,
    "api_key": "dmn_live_new_key_here...",
    ...
  }
}
```

**‚ö†Ô∏è Aten√ß√£o:** A chave anterior ser√° invalidada imediatamente.

---

## üéØ Estrutura de Dados

### Domain Entity

```php
Domain {
    +id: int
    +name: string
    +slug: string
    +domain_url: string
    +site_id: string
    +api_key: string
    +status: string
    +timezone: string
    +wordpress_version: string
    +plugin_version: string
    +settings: array
    +is_active: bool
}
```

### Settings Structure (Exemplo)

```json
{
  "enable_notifications": true,
  "report_frequency": "daily",
  "max_retries": 3,
  "webhook_url": "https://example.com/webhook",
  "custom_fields": {
    "business_type": "ISP Comparison",
    "contact_email": "tech@example.com"
  }
}
```

---

## üîê Permiss√µes de Domain

5 permiss√µes criadas no sistema:

| Slug | Nome | Descri√ß√£o | Uso |
|------|------|-----------|-----|
| `domain-create` | Create Domain | Criar novos dom√≠nios | Super admins |
| `domain-read` | View Domain | Visualizar dom√≠nios | Todos admins |
| `domain-update` | Update Domain | Atualizar dom√≠nios | Domain admins |
| `domain-delete` | Delete Domain | Deletar dom√≠nios | Super admins |
| `domain-manage` | Manage Domain | Gerenciar API keys | Super admins |

**Hierarquia recomendada:**
- **Super Admin:** Todas as permiss√µes
- **Domain Admin:** read, update, manage (para seus dom√≠nios)
- **Analyst:** read apenas

---

## üß™ Testes Implementados

Total: **12 testes** em `tests/Feature/Admin/DomainManagementTest.php`

### Testes de Listagem
1. ‚úÖ `super_admin_can_list_domains` - Lista com pagina√ß√£o
2. ‚úÖ `can_paginate_domains` - Pagina√ß√£o customizada
3. ‚úÖ `can_search_domains_by_name` - Busca funcional
4. ‚úÖ `can_filter_domains_by_active_status` - Filtro por status

### Testes de CRUD
5. ‚úÖ `super_admin_can_create_domain` - Cria√ß√£o com valida√ß√£o
6. ‚úÖ `super_admin_can_update_domain` - Atualiza√ß√£o
7. ‚úÖ `super_admin_can_delete_domain` - Remo√ß√£o
8. ‚úÖ `super_admin_can_get_domain_by_id` - Busca individual

### Testes de API Key
9. ‚úÖ `super_admin_can_regenerate_api_key` - Regenera√ß√£o segura

### Testes de Valida√ß√£o
10. ‚úÖ `cannot_create_domain_with_duplicate_slug` - Unique constraint
11. ‚úÖ `cannot_create_domain_without_required_fields` - Valida√ß√£o

### Testes de Permiss√µes
12. ‚úÖ `admin_without_domain_read_cannot_list_domains` - Autoriza√ß√£o
13. ‚úÖ `unauthenticated_user_cannot_access_domains` - Autentica√ß√£o

**Como executar:**
```bash
php artisan test --filter=DomainManagementTest
```

---

## üìä Exemplo de Uso

### 1. Criar um Novo Dom√≠nio

```bash
curl -X POST http://localhost/api/admin/domains \
  -H "Authorization: Bearer {super_admin_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "InternetFinder.com",
    "domain_url": "api.internetfinder.com",
    "site_id": "wp-prod-if-001",
    "timezone": "America/New_York",
    "wordpress_version": "6.8.3",
    "plugin_version": "2.0.0",
    "settings": {
      "enable_notifications": true,
      "report_frequency": "daily"
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Domain created successfully",
  "data": {
    "id": 5,
    "name": "InternetFinder.com",
    "slug": "internetfindercom",
    "api_key": "dmn_live_abc123xyz789...",
    "is_active": true,
    ...
  }
}
```

### 2. Listar Dom√≠nios Ativos

```bash
curl -X GET "http://localhost/api/admin/domains?is_active=true&per_page=20" \
  -H "Authorization: Bearer {admin_token}"
```

### 3. Buscar Dom√≠nio

```bash
curl -X GET "http://localhost/api/admin/domains?search=SmarterHome" \
  -H "Authorization: Bearer {admin_token}"
```

### 4. Atualizar Dom√≠nio

```bash
curl -X PUT http://localhost/api/admin/domains/5 \
  -H "Authorization: Bearer {admin_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "InternetFinder Pro",
    "timezone": "America/Chicago"
  }'
```

### 5. Regenerar API Key

```bash
curl -X POST http://localhost/api/admin/domains/5/regenerate-api-key \
  -H "Authorization: Bearer {super_admin_token}"
```

**‚ö†Ô∏è Importante:** A antiga API key deixar√° de funcionar imediatamente!

---

## üèóÔ∏è Arquitetura Implementada

### Fluxo de Request

```
HTTP Request
    ‚Üì
Route (middleware: auth:sanctum, admin.auth)
    ‚Üì
DomainController
    ‚Üì (valida input)
    ‚Üì (verifica permiss√£o via AuthorizeActionUseCase)
    ‚Üì
Use Case (GetAllDomainsUseCase, CreateDomainUseCase, etc)
    ‚Üì
Repository (DomainRepository)
    ‚Üì
Eloquent Model (Domain)
    ‚Üì
Database (domains table)
    ‚Üì (retorna Model)
Model ‚Üí Entity ‚Üí DTO ‚Üí Array
    ‚Üì
JSON Response
```

### Separa√ß√£o de Responsabilidades

#### Domain Entity
- Representa conceito de neg√≥cio
- Imut√°vel (readonly properties)
- Sem depend√™ncias de framework

#### DTO
- Transfer√™ncia de dados entre camadas
- Serializa√ß√£o para JSON
- Pode incluir ou n√£o API key

#### Repository
- Abstra√ß√£o de persist√™ncia
- Interface no Domain, implementa√ß√£o na Infrastructure
- Converte Models em Entities

#### Use Case
- L√≥gica de neg√≥cio
- Orquestra repositories
- Converte Entities em DTOs

#### Controller
- Lida com HTTP
- Valida inputs
- Verifica permiss√µes
- Retorna JSON

---

## üîí Seguran√ßa

### API Keys

**Formato:** `dmn_live_{64_caracteres_aleat√≥rios}`

**Gera√ß√£o:**
```php
$apiKey = 'dmn_live_' . Str::random(64);
```

**Armazenamento:**
- N√£o h√° hash no momento (plain text)
- **TODO Futuro:** Considerar hash com bcrypt

**Uso:**
- Dom√≠nios usam API key para enviar relat√≥rios
- Header: `Authorization: Bearer {api_key}`

### Permiss√µes Requeridas

| A√ß√£o | Permiss√£o | T√≠pico User |
|------|-----------|-------------|
| Listar dom√≠nios | `domain-read` | Todos admins |
| Ver detalhes | `domain-read` | Todos admins |
| Criar dom√≠nio | `domain-create` | Super admin |
| Atualizar | `domain-update` | Super admin |
| Deletar | `domain-delete` | Super admin |
| Regenerar API key | `domain-manage` | Super admin |

---

## üìà Features Implementadas

### Pagina√ß√£o ‚úÖ
- P√°gina atual e total de p√°ginas
- Configur√°vel (1-100 itens por p√°gina)
- Padr√£o: 15 itens

### Busca ‚úÖ
- Por nome do dom√≠nio
- Por domain_url
- Por slug
- Case-insensitive (LIKE)

### Filtros ‚úÖ
- Por status ativo/inativo
- Combin√°vel com busca

### Valida√ß√µes ‚úÖ
- Campos obrigat√≥rios: name, domain_url
- Formatos v√°lidos
- Unique constraints (slug, api_key)

### Autoriza√ß√£o ‚úÖ
- Verifica√ß√£o de permiss√µes em cada endpoint
- Super admin bypass
- Mensagens de erro claras

---

## üé® Pr√≥ximos Passos

### Implementa√ß√µes Futuras

#### 1. **Admin Domain Access Table**
Tabela para controlar quais admins t√™m acesso a quais dom√≠nios:

```sql
CREATE TABLE admin_domain_access (
    id BIGSERIAL PRIMARY KEY,
    admin_id BIGINT REFERENCES admins(id),
    domain_id BIGINT REFERENCES domains(id),
    access_level VARCHAR(20),
    granted_by BIGINT REFERENCES admins(id),
    granted_at TIMESTAMP,
    expires_at TIMESTAMP,
    is_active BOOLEAN
);
```

Isso permitir√°:
- Acesso granular por dom√≠nio
- Domain-specific admins
- Controle de expira√ß√£o

#### 2. **Estat√≠sticas de Dom√≠nio**
Adicionar ao DTO:
- `last_report_date` - Data do √∫ltimo relat√≥rio recebido
- `total_reports` - Total de relat√≥rios hist√≥ricos
- `avg_success_rate` - Taxa m√©dia de sucesso
- `status_message` - Mensagem de status

#### 3. **Webhook Configuration**
Permitir configurar webhooks em `settings`:
```json
{
  "webhook_url": "https://partner.com/webhook",
  "webhook_events": ["report_processed", "anomaly_detected"]
}
```

#### 4. **Domain Health Check**
Endpoint para verificar sa√∫de do dom√≠nio:
```
GET /api/admin/domains/{id}/health
```

#### 5. **API Key Rotation Policy**
- Auto-expira√ß√£o de API keys
- Notifica√ß√£o antes de expirar
- Dual-key support (transi√ß√£o suave)

---

## üìù Migra√ß√µes Necess√°rias

Se ainda n√£o tiver, execute:

```bash
php artisan migrate
```

Isso criar√° a tabela `domains` com a estrutura:
- id
- name
- slug (unique)
- domain_url
- site_id
- api_key (unique)
- status
- timezone
- wordpress_version
- plugin_version
- settings (json)
- is_active
- timestamps

---

## üß™ Como Testar

### 1. Seed Permissions
```bash
php artisan db:seed --class=PermissionSeeder
```

### 2. Criar Dom√≠nios de Teste
```bash
php artisan tinker
>>> App\Models\Domain::factory()->count(10)->create()
```

### 3. Testar API
```bash
# Login como super admin
POST /api/admin/login
{
  "email": "sudo@dashboard.com",
  "password": "password123"
}

# Listar dom√≠nios
GET /api/admin/domains?page=1&per_page=10
Authorization: Bearer {token}
```

### 4. Executar Testes
```bash
php artisan test --filter=DomainManagementTest
```

---

## ‚úÖ Checklist de Valida√ß√£o

- ‚úÖ Migration executada
- ‚úÖ Model criado e configurado
- ‚úÖ Entity implementada
- ‚úÖ DTO implementado
- ‚úÖ Repository interface definida
- ‚úÖ Repository implementado
- ‚úÖ Use cases criados (6 total)
- ‚úÖ Controller implementado
- ‚úÖ Rotas registradas
- ‚úÖ Permiss√µes adicionadas ao seeder
- ‚úÖ Factory criada
- ‚úÖ Testes implementados (12 total)
- ‚úÖ Binding no ServiceProvider
- ‚úÖ Documenta√ß√£o completa

---

## üéâ Conclus√£o

O m√≥dulo de **Domain Management** est√° **100% implementado** e pronto para uso!

**Funcionalidades dispon√≠veis:**
- ‚úÖ CRUD completo de dom√≠nios
- ‚úÖ Pagina√ß√£o e filtros
- ‚úÖ Sistema de permiss√µes
- ‚úÖ Gera√ß√£o autom√°tica de API keys
- ‚úÖ Regenera√ß√£o segura de chaves
- ‚úÖ Valida√ß√µes robustas
- ‚úÖ Testes completos

**Padr√µes seguidos:**
- ‚úÖ Clean Architecture
- ‚úÖ Domain-Driven Design
- ‚úÖ SOLID Principles
- ‚úÖ RESTful API Design
- ‚úÖ Comprehensive Testing

**Pr√≥ximo passo:** Implementar a funcionalidade de Reports (receber e processar JSONs dos dom√≠nios).

---

**Data:** 2025-10-11  
**Status:** ‚úÖ Implementa√ß√£o Completa  
**Vers√£o:** 1.0.0

