# üìä Proposta: Relat√≥rios Cross-Domain

## üéØ Objetivo

Criar endpoints que agregam dados de **TODOS os dom√≠nios**, permitindo an√°lises comparativas, rankings e insights globais.

---

## üöÄ Relat√≥rios Propostos (Ordem de Prioridade)

### **1. Ranking de Dom√≠nios** üèÜ (PRIORIDADE ALTA)

**Endpoint:** `GET /api/admin/reports/global/domain-ranking`

**O que faz:**
- Rankeia todos os dom√≠nios por diferentes m√©tricas
- Permite compara√ß√£o direta entre dom√≠nios
- Identifica l√≠deres e underperformers

**M√©tricas de Ranking:**
- Por volume total de requisi√ß√µes
- Por taxa de sucesso
- Por velocidade m√©dia
- Por score combinado (volume √ó success_rate)

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "ranking": [
      {
        "rank": 1,
        "domain": {
          "id": 2,
          "name": "smarterhome.ai"
        },
        "metrics": {
          "total_requests": 3620,
          "success_rate": 96.0,
          "avg_speed": 1743,
          "score": 3475.2,
          "total_reports": 40,
          "period": "93 days"
        }
      },
      {
        "rank": 2,
        "domain": {
          "id": 4,
          "name": "broadbandcheck.io"
        },
        "metrics": {
          "total_requests": 2714,
          "success_rate": 94.6,
          "avg_speed": 2014,
          "score": 2567.4,
          "total_reports": 40,
          "period": "93 days"
        }
      }
    ],
    "sort_by": "score",
    "total_domains": 4
  }
}
```

**Filtros sugeridos:**
- `?sort_by=volume|success_rate|avg_speed|score` (default: score)
- `?date_from=2025-06-01` (filtrar por per√≠odo)
- `?date_to=2025-09-30`
- `?min_reports=30` (dom√≠nios com pelo menos X relat√≥rios)

---

### **2. Compara√ß√£o Direta entre Dom√≠nios** üîÑ (PRIORIDADE ALTA)

**Endpoint:** `GET /api/admin/reports/global/comparison`

**O que faz:**
- Compara m√©tricas espec√≠ficas entre dom√≠nios selecionados
- Mostra diferen√ßas percentuais
- Identifica pontos fortes/fracos de cada dom√≠nio

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "domains": [
      {
        "id": 1,
        "name": "zip.50g.io",
        "metrics": {
          "total_requests": 1490,
          "success_rate": 92.4,
          "avg_speed": 1503,
          "top_state": "CA",
          "top_provider": "Viasat"
        }
      },
      {
        "id": 2,
        "name": "smarterhome.ai",
        "metrics": {
          "total_requests": 3620,
          "success_rate": 96.0,
          "avg_speed": 1743,
          "top_state": "CA",
          "top_provider": "Verizon"
        },
        "vs_domain_1": {
          "requests_diff": "+143%",
          "success_diff": "+3.6%",
          "speed_diff": "+16%"
        }
      }
    ],
    "comparison_type": "all_metrics"
  }
}
```

**Filtros sugeridos:**
- `?domains=1,2,3` (selecionar dom√≠nios espec√≠ficos)
- `?metric=volume|success|speed` (comparar m√©trica espec√≠fica)

---

### **3. M√©tricas Globais Agregadas** üåê (PRIORIDADE M√âDIA)

**Endpoint:** `GET /api/admin/reports/global/metrics`

**O que faz:**
- Agrega todas as m√©tricas de todos os dom√≠nios
- Fornece vis√£o geral da plataforma
- Estat√≠sticas consolidadas

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "summary": {
      "total_domains": 4,
      "active_domains": 4,
      "total_reports": 160,
      "total_requests": 8722,
      "global_success_rate": 91.85,
      "global_avg_speed": 1545.5
    },
    "top_providers_global": [
      {
        "name": "Viasat Carrier Services Inc",
        "total_requests": 8231,
        "domain_count": 4,
        "avg_success_rate": 92.3
      }
    ],
    "top_states_global": [
      {
        "code": "CA",
        "name": "California",
        "total_requests": 2061,
        "domain_count": 4,
        "avg_speed": 1650.5
      }
    ],
    "technology_distribution": [
      {
        "technology": "Mobile",
        "total_requests": 22928,
        "percentage": 36.3,
        "domain_count": 4
      }
    ]
  }
}
```

---

### **4. An√°lise de Tecnologias Cross-Domain** üîß (PRIORIDADE M√âDIA)

**Endpoint:** `GET /api/admin/reports/global/technologies`

**O que faz:**
- Analisa distribui√ß√£o de tecnologias entre todos os dom√≠nios
- Identifica prefer√™ncias por dom√≠nio
- Compara performance por tecnologia

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "technologies": [
      {
        "technology": "Mobile",
        "global_metrics": {
          "total_requests": 22928,
          "percentage": 36.3,
          "avg_success_rate": 93.2,
          "avg_speed": 1820.5
        },
        "by_domain": [
          {
            "domain_id": 2,
            "domain_name": "smarterhome.ai",
            "requests": 8500,
            "percentage": 37.1
          }
        ]
      }
    ],
    "insights": [
      "Mobile √© a tecnologia mais usada (36.3%)",
      "smarterhome.ai tem a maior prefer√™ncia por Fiber",
      "ispfinder.net √© focado em Mobile"
    ]
  }
}
```

**Filtros sugeridos:**
- `?technology=Mobile|Fiber|Cable|Satellite|DSL` (filtrar tecnologia espec√≠fica)
- `?min_requests=100` (tecnologias com pelo menos X requisi√ß√µes)

---

### **5. An√°lise Geogr√°fica Cross-Domain** üó∫Ô∏è (PRIORIDADE M√âDIA)

**Endpoint:** `GET /api/admin/reports/global/geographic`

**O que faz:**
- Mostra distribui√ß√£o geogr√°fica global
- Identifica hotspots de cada dom√≠nio
- Compara cobertura geogr√°fica

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "states": [
      {
        "code": "CA",
        "name": "California",
        "total_requests": 2061,
        "avg_speed": 1650.5,
        "by_domain": [
          {
            "domain_id": 2,
            "domain_name": "smarterhome.ai",
            "requests": 1200,
            "percentage_of_state": 58.2,
            "is_hotspot": true
          },
          {
            "domain_id": 1,
            "domain_name": "zip.50g.io",
            "requests": 239,
            "percentage_of_state": 11.6,
            "is_hotspot": false
          }
        ]
      }
    ],
    "insights": [
      "CA √© o estado mais ativo (2,061 requests)",
      "smarterhome.ai domina em CA (58.2% do tr√°fego)",
      "ispfinder.net √© forte em FL, GA, NC"
    ]
  }
}
```

---

### **6. Trends Temporais Cross-Domain** üìà (PRIORIDADE BAIXA)

**Endpoint:** `GET /api/admin/reports/global/trends`

**O que faz:**
- Mostra evolu√ß√£o ao longo do tempo
- Compara crescimento entre dom√≠nios
- Identifica padr√µes sazonais

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "daily_trends": [
      {
        "date": "2025-06-27",
        "by_domain": [
          {
            "domain_id": 1,
            "domain_name": "zip.50g.io",
            "requests": 114,
            "success_rate": 90.35
          },
          {
            "domain_id": 2,
            "domain_name": "smarterhome.ai",
            "requests": 268,
            "success_rate": 95.52
          }
        ],
        "global_total": 650
      }
    ],
    "growth_rates": [
      {
        "domain_id": 2,
        "domain_name": "smarterhome.ai",
        "growth_percentage": 15.2,
        "trend": "growing"
      }
    ]
  }
}
```

---

### **7. Performance Benchmark** ‚ö° (PRIORIDADE BAIXA)

**Endpoint:** `GET /api/admin/reports/global/benchmark`

**O que faz:**
- Estabelece benchmarks baseados nos melhores performers
- Compara cada dom√≠nio com o benchmark
- Identifica √°reas de melhoria

**Exemplo de Resposta:**
```json
{
  "success": true,
  "data": {
    "benchmarks": {
      "best_success_rate": {
        "value": 96.0,
        "domain": "smarterhome.ai"
      },
      "best_avg_speed": {
        "value": 2014,
        "domain": "broadbandcheck.io"
      },
      "highest_volume": {
        "value": 3620,
        "domain": "smarterhome.ai"
      }
    },
    "domain_scores": [
      {
        "domain_id": 2,
        "domain_name": "smarterhome.ai",
        "benchmark_score": 95.5,
        "strengths": ["success_rate", "volume"],
        "weaknesses": ["avg_speed"]
      }
    ]
  }
}
```

---

## üéØ Recomenda√ß√£o de Implementa√ß√£o

### **FASE 1 - Essencial** (Implementar primeiro)

1. **Ranking de Dom√≠nios** üèÜ
   - Use Case: `GetGlobalDomainRankingUseCase`
   - Controller method: `ReportController::globalRanking()`
   - Testes: `GlobalDomainRankingTest.php`

2. **Compara√ß√£o Direta** üîÑ
   - Use Case: `CompareDomainsUseCase`
   - Controller method: `ReportController::compareDomains()`
   - Testes: `CompareDomains Test.php`

### **FASE 2 - Importante** (Implementar depois)

3. **M√©tricas Globais** üåê
   - Use Case: `GetGlobalMetricsUseCase`
   - Controller method: `ReportController::globalMetrics()`
   - Testes: `GlobalMetricsTest.php`

4. **An√°lise de Tecnologias** üîß
   - Use Case: `GetGlobalTechnologyAnalysisUseCase`
   - Controller method: `ReportController::globalTechnologies()`
   - Testes: `GlobalTechnologyAnalysisTest.php`

### **FASE 3 - Adicional** (Implementar se houver tempo)

5. **An√°lise Geogr√°fica** üó∫Ô∏è
6. **Trends Temporais** üìà
7. **Performance Benchmark** ‚ö°

---

## üèóÔ∏è Estrutura de Arquivos Sugerida

```
app/Application/UseCases/Report/Global/
‚îú‚îÄ‚îÄ GetGlobalDomainRankingUseCase.php
‚îú‚îÄ‚îÄ CompareDomainsUseCase.php
‚îú‚îÄ‚îÄ GetGlobalMetricsUseCase.php
‚îú‚îÄ‚îÄ GetGlobalTechnologyAnalysisUseCase.php
‚îú‚îÄ‚îÄ GetGlobalGeographicAnalysisUseCase.php
‚îî‚îÄ‚îÄ GetGlobalTrendsUseCase.php

app/Application/DTOs/Report/Global/
‚îú‚îÄ‚îÄ DomainRankingDTO.php
‚îú‚îÄ‚îÄ GlobalMetricsDTO.php
‚îú‚îÄ‚îÄ TechnologyAnalysisDTO.php
‚îî‚îÄ‚îÄ DomainComparisonDTO.php

tests/Feature/Report/Global/
‚îú‚îÄ‚îÄ GlobalDomainRankingTest.php
‚îú‚îÄ‚îÄ CompareDomainsFunctionalTest.php
‚îî‚îÄ‚îÄ GlobalMetricsTest.php

tests/Unit/Application/UseCases/Report/Global/
‚îú‚îÄ‚îÄ GetGlobalDomainRankingUseCaseTest.php
‚îú‚îÄ‚îÄ CompareDomainsUseCaseTest.php
‚îî‚îÄ‚îÄ GetGlobalMetricsUseCaseTest.php
```

---

## üìã Rotas Sugeridas

```php
// routes/api.php

Route::middleware(['auth:sanctum', 'admin.auth'])->prefix('admin/reports/global')->group(function () {
    // FASE 1 - Essencial
    Route::get('/domain-ranking', [ReportController::class, 'globalRanking'])
        ->name('admin.reports.global.ranking');
    
    Route::get('/comparison', [ReportController::class, 'compareDomains'])
        ->name('admin.reports.global.comparison');
    
    // FASE 2 - Importante
    Route::get('/metrics', [ReportController::class, 'globalMetrics'])
        ->name('admin.reports.global.metrics');
    
    Route::get('/technologies', [ReportController::class, 'globalTechnologies'])
        ->name('admin.reports.global.technologies');
    
    // FASE 3 - Adicional
    Route::get('/geographic', [ReportController::class, 'globalGeographic'])
        ->name('admin.reports.global.geographic');
    
    Route::get('/trends', [ReportController::class, 'globalTrends'])
        ->name('admin.reports.global.trends');
});
```

---

## üß™ Testes Sugeridos

### **Feature Tests**

#### **GlobalDomainRankingTest.php**
```php
test_admin_can_get_global_domain_ranking()
test_ranking_can_be_sorted_by_volume()
test_ranking_can_be_sorted_by_success_rate()
test_ranking_can_be_sorted_by_speed()
test_ranking_can_be_filtered_by_date_range()
test_ranking_includes_all_active_domains()
test_ranking_excludes_inactive_domains()
test_unauthenticated_users_cannot_access()
```

#### **CompareDomainsFunctionalTest.php**
```php
test_admin_can_compare_two_domains()
test_admin_can_compare_multiple_domains()
test_comparison_shows_percentage_differences()
test_comparison_can_filter_by_metric()
test_comparison_requires_at_least_one_domain()
test_invalid_domain_ids_return_error()
```

#### **GlobalMetricsTest.php**
```php
test_admin_can_get_global_metrics()
test_global_metrics_aggregates_all_domains()
test_global_metrics_shows_top_providers()
test_global_metrics_shows_top_states()
test_global_metrics_shows_technology_distribution()
```

### **Unit Tests**

#### **GetGlobalDomainRankingUseCaseTest.php**
```php
test_execute_returns_domains_sorted_by_score()
test_execute_can_sort_by_volume()
test_execute_can_sort_by_success_rate()
test_execute_filters_by_date_range()
test_execute_handles_no_domains()
test_execute_calculates_score_correctly()
```

---

## üí° Insights Autom√°ticos Sugeridos

Cada endpoint pode retornar insights autom√°ticos baseados nos dados:

```json
{
  "insights": [
    "smarterhome.ai tem 143% mais requisi√ß√µes que zip.50g.io",
    "broadbandcheck.io tem a melhor velocidade m√©dia (2,014 Mbps)",
    "ispfinder.net tem a menor taxa de sucesso (84.4%)",
    "Mobile √© a tecnologia mais usada (36.3% das requisi√ß√µes)",
    "California representa 23.6% de todo o tr√°fego",
    "Viasat e Verizon dominam em todos os dom√≠nios"
  ]
}
```

---

## üé® Visualiza√ß√µes Sugeridas no Frontend

### **1. Dashboard Global**
- Cards com m√©tricas globais totais
- Gr√°fico de pizza: Distribui√ß√£o de requests por dom√≠nio
- Tabela comparativa: M√©tricas lado a lado

### **2. Ranking de Dom√≠nios**
- Tabela orden√°vel por diferentes m√©tricas
- Badges de "Top Performer", "Growing", "Needs Attention"
- Mini-sparklines de trends

### **3. Mapa Comparativo**
- Mapa dos EUA com layers por dom√≠nio
- Heatmap mostrando fortalezas de cada dom√≠nio por estado
- Toggle para alternar entre dom√≠nios

### **4. An√°lise de Tecnologias**
- Stacked bar chart: Tecnologias por dom√≠nio
- Tabela de performance por tecnologia
- Insights de prefer√™ncias

---

## üîß Detalhes de Implementa√ß√£o

### **C√°lculo do Score Combinado**

```php
$score = ($totalRequests / 1000) * ($successRate / 100) * (log($avgSpeed + 1) / 10);

// Normalizar para 0-100
$normalizedScore = min(100, $score);
```

### **Filtros de Data**

```php
if ($dateFrom && $dateTo) {
    $reports = Report::whereBetween('report_date', [$dateFrom, $dateTo])
        ->where('status', 'processed')
        ->get();
}
```

### **Agrega√ß√£o Eficiente**

```php
// Use DB queries para performance
$ranking = DB::table('report_summaries as rs')
    ->join('reports as r', 'r.id', '=', 'rs.report_id')
    ->join('domains as d', 'd.id', '=', 'r.domain_id')
    ->select(
        'd.id',
        'd.name',
        DB::raw('SUM(rs.total_requests) as total_requests'),
        DB::raw('AVG(rs.success_rate) as avg_success_rate'),
        DB::raw('COUNT(r.id) as report_count')
    )
    ->where('d.is_active', true)
    ->where('r.status', 'processed')
    ->groupBy('d.id', 'd.name')
    ->orderByDesc('total_requests')
    ->get();
```

---

## üéØ Resumo da Proposta

| Relat√≥rio | Prioridade | Complexidade | Valor para Usu√°rio |
|-----------|-----------|--------------|-------------------|
| Ranking de Dom√≠nios | üî¥ ALTA | M√©dia | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| Compara√ß√£o Direta | üî¥ ALTA | Baixa | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| M√©tricas Globais | üü° M√âDIA | Baixa | ‚≠ê‚≠ê‚≠ê‚≠ê |
| An√°lise de Tecnologias | üü° M√âDIA | M√©dia | ‚≠ê‚≠ê‚≠ê‚≠ê |
| An√°lise Geogr√°fica | üü¢ BAIXA | Alta | ‚≠ê‚≠ê‚≠ê |
| Trends Temporais | üü¢ BAIXA | Alta | ‚≠ê‚≠ê‚≠ê |
| Performance Benchmark | üü¢ BAIXA | M√©dia | ‚≠ê‚≠ê‚≠ê |

---

## üöÄ Sugest√£o de Implementa√ß√£o

**Come√ßar com FASE 1** (2 endpoints mais importantes):

1. **Ranking de Dom√≠nios** - Permite identificar l√≠deres
2. **Compara√ß√£o Direta** - Permite an√°lise detalhada

Estes 2 endpoints cobrem 80% das necessidades de an√°lise cross-domain e s√£o relativamente simples de implementar.

---

## üìö Pr√≥ximos Passos

1. Revisar e aprovar esta proposta
2. Implementar FASE 1 (Ranking + Compara√ß√£o)
3. Criar testes Feature e Unit
4. Documentar endpoints
5. Implementar FASE 2 se necess√°rio

---

üéâ **Proposta completa de relat√≥rios cross-domain pronta para implementa√ß√£o!**
